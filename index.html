<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis Cerita Anak</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ffa726);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .header p {
            margin: 10px 0 20px 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .mode-switcher {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn-mode {
            padding: 10px 20px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-mode.active,
        .btn-mode:hover {
            background: white;
            color: #ff6b6b;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .teacher-dashboard {
            display: none;
        }
        
        .dashboard-header {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
            text-align: center;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .results-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .table-header {
            background: #667eea;
            color: white;
            padding: 20px;
            font-weight: bold;
        }
        
        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s ease;
        }
        
        .result-item:hover {
            background: #f8f9ff;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .student-info-display {
            font-weight: bold;
            color: #333;
        }
        
        .book-info {
            color: #666;
            font-size: 0.9rem;
        }
        
        .result-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-small {
            padding: 5px 15px;
            font-size: 0.8rem;
            border-radius: 15px;
        }
        
        .student-info {
            background: #f8f9ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }
        
        .teacher-email {
            background: #fff0f5;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 5px solid #ff6b6b;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }
        
        .analysis-section {
            background: #fff8f0;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            border-left: 5px solid #ffa726;
        }
        
        .section-title {
            color: #ff6b6b;
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            content: "üìö";
            margin-right: 10px;
            font-size: 1.5rem;
        }
        
        .character-analysis .section-title::before { content: "üë•"; }
        .setting-analysis .section-title::before { content: "üèûÔ∏è"; }
        .conflict-analysis .section-title::before { content: "‚ö°"; }
        .moral-analysis .section-title::before { content: "üíé"; }
        .summary-analysis .section-title::before { content: "üìù"; }
        
        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 40px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(86, 171, 47, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }
        
        .btn-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(23, 162, 184, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #bdc3c7, #2c3e50);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(44, 62, 80, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }
        
        .saved-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #28a745;
            display: none;
        }
        
        .email-info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #2196f3;
            font-size: 0.9rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #999;
        }
        
        .login-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-header h2 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        .login-option {
            background: #f8f9ff;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .login-option:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        
        .login-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }
        
        .login-option h3 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-option p {
            color: #666;
            margin-bottom: 25px;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .form-container {
                padding: 20px;
            }
            
            .buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                max-width: 300px;
            }
            
            .mode-switcher {
                flex-direction: column;
                align-items: center;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .login-options {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .login-option {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìñ Analisis Cerita Anak</h1>
            <p>Analisis unsur-unsur cerita dan kirim langsung ke guru!</p>
        </div>
        
        <div class="form-container">
            <!-- Login Form -->
            <div id="loginSection">
                <div class="login-container">
                    <div class="login-header">
                        <h2>üîê Login Sistem</h2>
                        <p>Silakan pilih jenis akun Anda</p>
                    </div>
                    
                    <div class="login-options">
                        <div class="login-option" id="studentLogin">
                            <div class="login-icon">üë®‚Äçüéì</div>
                            <h3>Login Siswa</h3>
                            <p>Masukkan nama lengkap Anda</p>
                            <form id="studentLoginForm">
                                <div class="form-group">
                                    <label for="studentLoginName">Nama Lengkap:</label>
                                    <input type="text" id="studentLoginName" name="studentLoginName" placeholder="Contoh: Ahmad Rizki Pratama" required>
                                </div>
                                <button type="submit" class="btn btn-primary">üöÄ Masuk sebagai Siswa</button>
                            </form>
                        </div>
                        
                        <div class="login-option" id="teacherLogin">
                            <div class="login-icon">üë©‚Äçüè´</div>
                            <h3>Login Guru</h3>
                            <p>Masukkan email guru</p>
                            <form id="teacherLoginForm">
                                <div class="form-group">
                                    <label for="teacherLoginEmail">Email Guru:</label>
                                    <input type="email" id="teacherLoginEmail" name="teacherLoginEmail" placeholder="......." required>
                                </div>
                                <button type="submit" class="btn btn-success">üéØ Masuk sebagai Guru</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Form -->
            <div id="studentSection" style="display: none;">
                <form id="analysisForm">
                    <div class="student-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; background: #f8f9ff; border-radius: 15px; padding: 25px; margin-bottom: 30px; border-left: 5px solid #667eea;">
                            <div>
                                <h3>üë®‚Äçüéì Selamat datang, <span id="currentStudentName"></span>!</h3>
                                <p>Silakan isi analisis cerita Anda dengan lengkap</p>
                            </div>
                            <button type="button" class="btn btn-secondary" id="studentLogoutBtn">üö™ Logout</button>
                        </div>
                    </div>
                    
                    <div class="teacher-email">
                        <div class="form-group">
                            <label for="teacherEmail">Email Guru:</label>
                            <input type="email" id="teacherEmail" name="teacherEmail" value="mulyono@sdialazhar52.sch.id" required>
                        </div>
                    </div>
                    
                    <div class="student-info">
                        <div class="form-group">
                            <label for="studentName">Nama Siswa:</label>
                            <input type="text" id="studentName" name="studentName" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="className">Kelas:</label>
                            <select id="className" name="className" required>
                                <option value="">Pilih Kelas</option>
                                <option value="1A">5 Makkah</option>
                                <option value="1B">5 Madinah</option>
                                <option value="2A">5 Mina</option>
                                <option value="2B">5 Marwah</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="bookTitle">Judul Buku Cerita:</label>
                            <input type="text" id="bookTitle" name="bookTitle" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="author">Pengarang:</label>
                            <input type="text" id="author" name="author" required>
                        </div>
                    </div>
                    
                    <div class="analysis-section character-analysis">
                        <div class="section-title">Analisis Tokoh dan Watak</div>
                        
                        <div class="form-group">
                            <label for="mainCharacter">Tokoh Utama:</label>
                            <input type="text" id="mainCharacter" name="mainCharacter" placeholder="Sebutkan nama tokoh utama dalam cerita" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="characterTraits">Watak Tokoh Utama:</label>
                            <textarea id="characterTraits" name="characterTraits" placeholder="Jelaskan sifat-sifat tokoh utama (contoh: baik hati, pemberani, rajin, dll)" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="supportingCharacters">Tokoh Pendukung:</label>
                            <textarea id="supportingCharacters" name="supportingCharacters" placeholder="Sebutkan tokoh-tokoh lain dalam cerita dan sifat mereka" required></textarea>
                        </div>
                    </div>
                    
                    <div class="analysis-section setting-analysis">
                        <div class="section-title">Analisis Latar</div>
                        
                        <div class="form-group">
                            <label for="settingPlace">Latar Tempat:</label>
                            <textarea id="settingPlace" name="settingPlace" placeholder="Di mana cerita ini terjadi? (contoh: di hutan, di sekolah, di rumah, dll)" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="settingTime">Latar Waktu:</label>
                            <textarea id="settingTime" name="settingTime" placeholder="Kapan cerita ini terjadi? (contoh: pada pagi hari, di musim hujan, zaman dahulu, dll)" required></textarea>
                        </div>
                    </div>
                    
                    <div class="analysis-section conflict-analysis">
                        <div class="section-title">Analisis Konflik</div>
                        
                        <div class="form-group">
                            <label for="conflict">Masalah/Konflik dalam Cerita:</label>
                            <textarea id="conflict" name="conflict" placeholder="Apa masalah atau tantangan yang dihadapi tokoh utama dalam cerita ini?" required></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="resolution">Penyelesaian Masalah:</label>
                            <textarea id="resolution" name="resolution" placeholder="Bagaimana masalah tersebut diselesaikan di akhir cerita?" required></textarea>
                        </div>
                    </div>
                    
                    <div class="analysis-section moral-analysis">
                        <div class="section-title">Nilai Moral</div>
                        
                        <div class="form-group">
                            <label for="moralValue">Pesan Moral dari Cerita:</label>
                            <textarea id="moralValue" name="moralValue" placeholder="Apa pelajaran atau nilai-nilai baik yang bisa kita ambil dari cerita ini?" required></textarea>
                        </div>
                    </div>
                    
                    <div class="analysis-section summary-analysis">
                        <div class="section-title">Ringkasan Cerita</div>
                        
                        <div class="form-group">
                            <label for="summary">Ringkasan Cerita:</label>
                            <textarea id="summary" name="summary" placeholder="Buatlah ringkasan cerita dengan kata-kata sendiri. Ceritakan dari awal hingga akhir secara singkat dan jelas." required style="min-height: 150px;"></textarea>
                        </div>
                    </div>
                    
                    <div class="email-info">
                        <strong>üìß Info Pengiriman:</strong><br>
                        Setelah menyimpan analisis, Anda dapat mengirim hasil ke email guru, mengunduh PDF, atau export ke CSV untuk Google Sheets. File CSV dapat langsung dibuka di Excel atau Google Sheets.
                    </div>
                    
                    <div class="saved-message" id="savedMessage">
                        ‚úÖ Analisis berhasil disimpan! Anda dapat mengunduh PDF, export CSV, atau mengirim ke guru sekarang.
                    </div>
                    
                    <div class="buttons">
                        <button type="submit" class="btn btn-primary">üíæ Simpan Analisis</button>
                        <button type="button" class="btn btn-success" id="exportPDF" disabled>üìÑ Unduh PDF</button>
                        <button type="button" class="btn btn-warning" id="sendEmail" disabled>üìß Kirim ke Guru</button>
                        <button type="button" class="btn btn-info" id="exportCSV" disabled>üìä Export CSV</button>
                        <button type="button" class="btn btn-secondary" id="resetForm">üîÑ Reset Form</button>
                    </div>
                </form>
            </div>

            <!-- Teacher Dashboard -->
            <div id="teacherSection" class="teacher-dashboard" style="display: none;">
                <div class="dashboard-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div>
                            <h2>üìä Dashboard Guru</h2>
                            <p>Selamat datang, <span id="teacherName">Mr. Mulyono</span></p>
                        </div>
                        <button type="button" class="btn btn-secondary" id="logoutBtn">üö™ Logout</button>
                    </div>
                    <p>Kelola dan lihat semua hasil analisis cerita siswa</p>
                </div>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalStudents">0</div>
                        <div>Total Siswa</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalBooks">0</div>
                        <div>Buku Dianalisis</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="completedToday">0</div>
                        <div>Selesai Hari Ini</div>
                    </div>
                </div>

                <div class="buttons" style="margin-bottom: 30px;">
                    <button type="button" class="btn btn-success" id="exportAllCSV">üìä Export Semua ke CSV</button>
                    <button type="button" class="btn btn-info" id="exportAllPDF">üìÑ Export Semua ke PDF</button>
                    <button type="button" class="btn btn-danger" id="clearAllData">üóëÔ∏è Hapus Semua Data</button>
                </div>

                <div class="results-table">
                    <div class="table-header">
                        üìö Hasil Analisis Siswa
                    </div>
                    <div class="table-content" id="resultsContainer">
                        <div class="empty-state">
                            <h3>Belum Ada Data</h3>
                            <p>Hasil analisis siswa akan muncul di sini setelah mereka mengirim tugas.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let savedData = null;
        let allStudentData = JSON.parse(localStorage.getItem('studentAnalysisData')) || [];
        let currentUser = null;

        // Login handlers
        document.getElementById('studentLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const studentName = document.getElementById('studentLoginName').value.trim();
            
            if (studentName.length < 3) {
                alert('Nama lengkap harus minimal 3 karakter!');
                return;
            }
            
            currentUser = {
                type: 'student',
                name: studentName
            };
            
            document.getElementById('currentStudentName').textContent = studentName;
            document.getElementById('studentName').value = studentName;
            
            showSection('studentSection');
        });

        document.getElementById('teacherLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const teacherEmail = document.getElementById('teacherLoginEmail').value.trim();
            
            if (teacherEmail !== 'mulyono@sdialazhar52.sch.id') {
                alert('Email guru tidak valid! Gunakan: .....');
                return;
            }
            
            currentUser = {
                type: 'teacher',
                email: teacherEmail
            };
            
            showSection('teacherSection');
            loadTeacherDashboard();
        });

        // Logout handlers
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('studentLogoutBtn').addEventListener('click', logout);

        function logout() {
            currentUser = null;
            savedData = null;
            document.getElementById('analysisForm').reset();
            document.getElementById('studentLoginForm').reset();
            document.getElementById('teacherLoginForm').reset();
            showSection('loginSection');
        }

        function showSection(sectionId) {
            const sections = ['loginSection', 'studentSection', 'teacherSection'];
            sections.forEach(id => {
                document.getElementById(id).style.display = id === sectionId ? 'block' : 'none';
            });
        }

        // Student form submission
        document.getElementById('analysisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            savedData = {};
            
            for (let [key, value] of formData.entries()) {
                savedData[key] = value;
            }
            
            savedData.timestamp = new Date().toLocaleString('id-ID');
            savedData.id = Date.now().toString();
            
            // Save to localStorage for teacher dashboard
            allStudentData.push(savedData);
            localStorage.setItem('studentAnalysisData', JSON.stringify(allStudentData));
            
            const savedMessage = document.getElementById('savedMessage');
            savedMessage.style.display = 'block';
            savedMessage.scrollIntoView({ behavior: 'smooth' });
            
            document.getElementById('exportPDF').disabled = false;
            document.getElementById('sendEmail').disabled = false;
            document.getElementById('exportCSV').disabled = false;
            
            setTimeout(() => {
                savedMessage.style.display = 'none';
            }, 3000);
        });

        // Load teacher dashboard
        function loadTeacherDashboard() {
            allStudentData = JSON.parse(localStorage.getItem('studentAnalysisData')) || [];
            
            // Update statistics
            document.getElementById('totalStudents').textContent = allStudentData.length;
            
            const uniqueBooks = new Set(allStudentData.map(data => data.bookTitle));
            document.getElementById('totalBooks').textContent = uniqueBooks.size;
            
            const today = new Date().toDateString();
            const todayCount = allStudentData.filter(data => 
                new Date(data.timestamp).toDateString() === today
            ).length;
            document.getElementById('completedToday').textContent = todayCount;
            
            // Load results
            const container = document.getElementById('resultsContainer');
            
            if (allStudentData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Belum Ada Data</h3>
                        <p>Hasil analisis siswa akan muncul di sini setelah mereka mengirim tugas.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allStudentData.map((data, index) => `
                <div class="result-item">
                    <div class="result-header">
                        <div class="student-info-display">
                            ${data.studentName} - ${data.className}
                        </div>
                    </div>
                    <div class="book-info">
                        üìñ ${data.bookTitle} oleh ${data.author}
                    </div>
                    <div class="book-info">
                        üìÖ ${data.timestamp}
                    </div>
                    <div class="result-actions">
                        <button class="btn btn-info btn-small" onclick="viewDetails(${index})">üëÅÔ∏è Lihat Detail</button>
                        <button class="btn btn-success btn-small" onclick="exportSinglePDF(${index})">üìÑ PDF</button>
                        <button class="btn btn-warning btn-small" onclick="exportSingleCSV(${index})">üìä CSV</button>
                        <button class="btn btn-danger btn-small" onclick="deleteResult(${index})">üóëÔ∏è Hapus</button>
                    </div>
                </div>
            `).join('');
        }

        // View details function
        function viewDetails(index) {
            const data = allStudentData[index];
            const detailWindow = window.open('', '_blank', 'width=800,height=600');
            detailWindow.document.write(`
                <html>
                <head>
                    <title>Detail Analisis - ${data.studentName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
                        .header { background: #667eea; color: white; padding: 20px; margin: -20px -20px 20px -20px; }
                        .section { margin-bottom: 20px; padding: 15px; background: #f8f9ff; border-radius: 8px; }
                        .label { font-weight: bold; color: #333; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìñ Detail Analisis Cerita</h1>
                        <p>${data.studentName} - ${data.className}</p>
                    </div>
                    
                    <div class="section">
                        <div class="label">Judul Buku:</div>
                        <div>${data.bookTitle}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Pengarang:</div>
                        <div>${data.author}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Tokoh Utama:</div>
                        <div>${data.mainCharacter}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Watak Tokoh Utama:</div>
                        <div>${data.characterTraits}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Tokoh Pendukung:</div>
                        <div>${data.supportingCharacters}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Latar Tempat:</div>
                        <div>${data.settingPlace}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Latar Waktu:</div>
                        <div>${data.settingTime}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Konflik:</div>
                        <div>${data.conflict}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Penyelesaian:</div>
                        <div>${data.resolution}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Nilai Moral:</div>
                        <div>${data.moralValue}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Ringkasan Cerita:</div>
                        <div>${data.summary}</div>
                    </div>
                    
                    <div class="section">
                        <div class="label">Tanggal Pengerjaan:</div>
                        <div>${data.timestamp}</div>
                    </div>
                </body>
                </html>
            `);
        }

        // Export all to CSV
        document.getElementById('exportAllCSV').addEventListener('click', function() {
            if (allStudentData.length === 0) {
                alert('Tidak ada data untuk diekspor!');
                return;
            }
            
            const csvHeaders = [
                'Nama Siswa', 'Kelas', 'Email Guru', 'Judul Buku', 'Pengarang',
                'Tokoh Utama', 'Watak Tokoh Utama', 'Tokoh Pendukung',
                'Latar Tempat', 'Latar Waktu', 'Konflik', 'Penyelesaian Masalah',
                'Nilai Moral', 'Ringkasan Cerita', 'Tanggal Pengerjaan'
            ];
            
            const escapeCsvField = (field) => {
                if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                    return '"' + field.replace(/"/g, '""') + '"';
                }
                return field;
            };
            
            let csvContent = csvHeaders.join(',') + '\n';
            
            allStudentData.forEach(data => {
                const csvRow = [
                    data.studentName, data.className, data.teacherEmail || '',
                    data.bookTitle, data.author, data.mainCharacter,
                    data.characterTraits, data.supportingCharacters,
                    data.settingPlace, data.settingTime, data.conflict,
                    data.resolution, data.moralValue, data.summary, data.timestamp
                ];
                csvContent += csvRow.map(escapeCsvField).join(',') + '\n';
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Semua_Analisis_Cerita_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Delete result
        function deleteResult(index) {
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                allStudentData.splice(index, 1);
                localStorage.setItem('studentAnalysisData', JSON.stringify(allStudentData));
                loadTeacherDashboard();
            }
        }

        // Clear all data
        document.getElementById('clearAllData').addEventListener('click', function() {
            if (confirm('Apakah Anda yakin ingin menghapus SEMUA data? Tindakan ini tidak dapat dibatalkan!')) {
                localStorage.removeItem('studentAnalysisData');
                allStudentData = [];
                loadTeacherDashboard();
            }
        });

        // Export single CSV
        function exportSingleCSV(index) {
            const data = allStudentData[index];
            const csvHeaders = [
                'Nama Siswa', 'Kelas', 'Email Guru', 'Judul Buku', 'Pengarang',
                'Tokoh Utama', 'Watak Tokoh Utama', 'Tokoh Pendukung',
                'Latar Tempat', 'Latar Waktu', 'Konflik', 'Penyelesaian Masalah',
                'Nilai Moral', 'Ringkasan Cerita', 'Tanggal Pengerjaan'
            ];
            
            const csvData = [
                data.studentName, data.className, data.teacherEmail || '',
                data.bookTitle, data.author, data.mainCharacter,
                data.characterTraits, data.supportingCharacters,
                data.settingPlace, data.settingTime, data.conflict,
                data.resolution, data.moralValue, data.summary, data.timestamp
            ];
            
            const escapeCsvField = (field) => {
                if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                    return '"' + field.replace(/"/g, '""') + '"';
                }
                return field;
            };
            
            const csvContent = csvHeaders.join(',') + '\n' + 
                              csvData.map(escapeCsvField).join(',');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Analisis_${data.studentName.replace(/\s+/g, '_')}_${data.bookTitle.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Export single PDF
        function exportSinglePDF(index) {
            const data = allStudentData[index];
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica');
            doc.setFontSize(20);
            doc.setTextColor(255, 107, 107);
            doc.text('ANALISIS CERITA ANAK', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            let yPos = 40;
            
            doc.text(`Nama Siswa: ${data.studentName}`, 20, yPos);
            yPos += 8;
            doc.text(`Kelas: ${data.className}`, 20, yPos);
            yPos += 8;
            doc.text(`Judul Buku: ${data.bookTitle}`, 20, yPos);
            yPos += 8;
            doc.text(`Pengarang: ${data.author}`, 20, yPos);
            yPos += 8;
            doc.text(`Tanggal: ${data.timestamp}`, 20, yPos);
            yPos += 15;
            
            const sections = [
                { title: 'TOKOH UTAMA', content: data.mainCharacter },
                { title: 'WATAK TOKOH UTAMA', content: data.characterTraits },
                { title: 'TOKOH PENDUKUNG', content: data.supportingCharacters },
                { title: 'LATAR TEMPAT', content: data.settingPlace },
                { title: 'LATAR WAKTU', content: data.settingTime },
                { title: 'KONFLIK', content: data.conflict },
                { title: 'PENYELESAIAN', content: data.resolution },
                { title: 'NILAI MORAL', content: data.moralValue },
                { title: 'RINGKASAN CERITA', content: data.summary }
            ];
            
            sections.forEach(section => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(11);
                doc.setTextColor(102, 126, 234);
                doc.text(section.title + ':', 20, yPos);
                yPos += 6;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                const lines = doc.splitTextToSize(section.content, 170);
                doc.text(lines, 20, yPos);
                yPos += lines.length * 5 + 8;
            });
            
            const fileName = `Analisis_${data.studentName.replace(/\s+/g, '_')}_${data.bookTitle.replace(/\s+/g, '_')}.pdf`;
            doc.save(fileName);
        }

        // Student form functions (existing)
        document.getElementById('exportCSV').addEventListener('click', function() {
            if (!savedData) {
                alert('Silakan simpan analisis terlebih dahulu!');
                return;
            }
            
            const csvHeaders = [
                'Nama Siswa', 'Kelas', 'Email Guru', 'Judul Buku', 'Pengarang',
                'Tokoh Utama', 'Watak Tokoh Utama', 'Tokoh Pendukung',
                'Latar Tempat', 'Latar Waktu', 'Konflik', 'Penyelesaian Masalah',
                'Nilai Moral', 'Ringkasan Cerita', 'Tanggal Pengerjaan'
            ];
            
            const csvData = [
                savedData.studentName, savedData.className, savedData.teacherEmail,
                savedData.bookTitle, savedData.author, savedData.mainCharacter,
                savedData.characterTraits, savedData.supportingCharacters,
                savedData.settingPlace, savedData.settingTime, savedData.conflict,
                savedData.resolution, savedData.moralValue, savedData.summary, savedData.timestamp
            ];
            
            const escapeCsvField = (field) => {
                if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                    return '"' + field.replace(/"/g, '""') + '"';
                }
                return field;
            };
            
            const csvContent = csvHeaders.join(',') + '\n' + 
                              csvData.map(escapeCsvField).join(',');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `Analisis_${savedData.studentName.replace(/\s+/g, '_')}_${savedData.bookTitle.replace(/\s+/g, '_')}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        document.getElementById('sendEmail').addEventListener('click', function() {
            if (!savedData) {
                alert('Silakan simpan analisis terlebih dahulu!');
                return;
            }
            
            const subject = `Analisis Cerita: ${savedData.bookTitle} - ${savedData.studentName}`;
            
            const emailBody = `
ANALISIS CERITA ANAK
====================

INFORMASI SISWA:
- Nama Siswa: ${savedData.studentName}
- Kelas: ${savedData.className}
- Tanggal: ${savedData.timestamp}

INFORMASI BUKU:
- Judul Buku: ${savedData.bookTitle}
- Pengarang: ${savedData.author}

ANALISIS UNSUR CERITA:
======================

TOKOH UTAMA:
${savedData.mainCharacter}

WATAK TOKOH UTAMA:
${savedData.characterTraits}

TOKOH PENDUKUNG:
${savedData.supportingCharacters}

LATAR TEMPAT:
${savedData.settingPlace}

LATAR WAKTU:
${savedData.settingTime}

KONFLIK:
${savedData.conflict}

PENYELESAIAN MASALAH:
${savedData.resolution}

NILAI MORAL:
${savedData.moralValue}

RINGKASAN CERITA:
${savedData.summary}

---
Dikirim melalui Aplikasi Analisis Cerita Anak
            `.trim();
            
            const mailtoLink = `mailto:${savedData.teacherEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            window.open(mailtoLink, '_blank');
            alert('Email telah dibuka di aplikasi email Anda. Silakan kirim email tersebut ke guru!');
        });

        document.getElementById('exportPDF').addEventListener('click', function() {
            if (!savedData) {
                alert('Silakan simpan analisis terlebih dahulu!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFont('helvetica');
            doc.setFontSize(20);
            doc.setTextColor(255, 107, 107);
            doc.text('ANALISIS CERITA ANAK', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            let yPos = 40;
            
            doc.text(`Nama Siswa: ${savedData.studentName}`, 20, yPos);
            yPos += 8;
            doc.text(`Kelas: ${savedData.className}`, 20, yPos);
            yPos += 8;
            doc.text(`Judul Buku: ${savedData.bookTitle}`, 20, yPos);
            yPos += 8;
            doc.text(`Pengarang: ${savedData.author}`, 20, yPos);
            yPos += 8;
            doc.text(`Tanggal: ${savedData.timestamp}`, 20, yPos);
            yPos += 15;
            
            const sections = [
                { title: 'TOKOH UTAMA', content: savedData.mainCharacter },
                { title: 'WATAK TOKOH UTAMA', content: savedData.characterTraits },
                { title: 'TOKOH PENDUKUNG', content: savedData.supportingCharacters },
                { title: 'LATAR TEMPAT', content: savedData.settingPlace },
                { title: 'LATAR WAKTU', content: savedData.settingTime },
                { title: 'KONFLIK', content: savedData.conflict },
                { title: 'PENYELESAIAN', content: savedData.resolution },
                { title: 'NILAI MORAL', content: savedData.moralValue },
                { title: 'RINGKASAN CERITA', content: savedData.summary }
            ];
            
            sections.forEach(section => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(11);
                doc.setTextColor(102, 126, 234);
                doc.text(section.title + ':', 20, yPos);
                yPos += 6;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                const lines = doc.splitTextToSize(section.content, 170);
                doc.text(lines, 20, yPos);
                yPos += lines.length * 5 + 8;
            });
            
            const fileName = `Analisis_${savedData.studentName.replace(/\s+/g, '_')}_${savedData.bookTitle.replace(/\s+/g, '_')}.pdf`;
            doc.save(fileName);
        });

        document.getElementById('resetForm').addEventListener('click', function() {
            if (confirm('Apakah Anda yakin ingin menghapus semua data yang telah diisi?')) {
                document.getElementById('analysisForm').reset();
                savedData = null;
                document.getElementById('exportPDF').disabled = true;
                document.getElementById('sendEmail').disabled = true;
                document.getElementById('exportCSV').disabled = true;
                document.getElementById('savedMessage').style.display = 'none';
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98472f933425f932',t:'MTc1ODc2ODMzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
